<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Hack Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@300;400;600&display=swap');
        body { margin: 0; padding: 40px 20px; background-color: #050505; font-family: 'Poppins', sans-serif; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        h2 { font-family: 'Orbitron', sans-serif; color: #00d4ff; text-shadow: 0 0 10px #00d4ff; font-size: 36px; margin-bottom: 20px; text-transform: uppercase; }

        .nav-btn { position: absolute; top: 20px; left: 20px; text-decoration: none; color: #00ff88; font-weight: bold; border: 1px solid #00ff88; padding: 10px 20px; border-radius: 20px; font-family: 'Orbitron', sans-serif; transition: 0.3s; cursor: pointer; }
        .nav-btn:hover { background: #00ff88; color: #000; box-shadow: 0 0 15px #00ff88; }
        .auth-btn { position: absolute; top: 20px; right: 20px; background: transparent; border: 1px solid #ff4444; color: #ff4444; font-weight: bold; padding: 10px 20px; border-radius: 20px; font-family: 'Orbitron', sans-serif; transition: 0.3s; cursor: pointer; }
        .auth-btn:hover { background: #ff4444; color: white; box-shadow: 0 0 15px #ff4444; }

        .filter-container { display: flex; gap: 10px; margin-bottom: 30px; width: 100%; max-width: 600px; }
        .search-box, .filter-select { padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; font-family: 'Poppins', sans-serif; }
        .search-box { flex: 2; } .filter-select { flex: 1; cursor: pointer; }

        .list-container { width: 100%; max-width: 900px; display: grid; grid-template-columns: 1fr; gap: 25px; }
        @media(min-width: 768px) { .list-container { grid-template-columns: 1fr 1fr; } }
        
        .hackathon-card { background: rgba(20, 20, 20, 0.9); border: 1px solid #333; border-top: 5px solid; padding: 30px; border-radius: 15px; transition: 0.3s; position: relative; }
        .hackathon-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); }
        .status-Winner { border-top-color: #FFD700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .status-Shortlisted { border-top-color: #bc13fe; } .status-Applied { border-top-color: #00d4ff; } 
        .status-Interested { border-top-color: #00ff88; } .status-Rejected { border-top-color: #ff4444; opacity: 0.8; } 
        .status-undefined { border-top-color: #888; }

        .title { font-size: 22px; font-weight: 800; margin-bottom: 5px; font-family: 'Orbitron', sans-serif; }
        .organizer { font-size: 13px; color: #888; margin-bottom: 15px; display: block; }
        .countdown-timer { font-family: 'Orbitron', sans-serif; font-size: 14px; color: #ffeb3b; background: rgba(255, 235, 59, 0.1); padding: 5px 10px; border-radius: 5px; display: inline-block; margin-bottom: 10px; border: 1px solid rgba(255, 235, 59, 0.3); }
        
        .date-highlight { font-size: 14px; font-weight: bold; color: #aaa; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #ccc; }
        
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 5px; background: #222; border: 1px solid #444; }
        .badge.yes { border-color: #00ff88; color: #00ff88; } .badge.no { border-color: #ff4444; color: #ff4444; }
        .status-badge { font-size: 11px; padding: 4px 8px; border-radius: 5px; background: #333; color: #fff; border: 1px solid #555; font-weight: bold; }

        .team-section { background: #111; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px dashed #333; }
        .team-status { font-size: 13px; font-weight: bold; margin-bottom: 5px; display: block; }
        .status-full { color: #ff4444; } .status-open { color: #00ff88; }
        .member-list { font-size: 12px; color: #bbb; font-style: italic; }

        .proof-btn { background: #111; border: 1px solid #00d4ff; color: #00d4ff; padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 11px; font-family: 'Poppins'; display: inline-flex; align-items: center; gap: 5px; transition: 0.3s; }
        .proof-btn:hover { background: #00d4ff; color: #000; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .visit-btn { flex: 1; text-align: center; background: #333; color: #fff; padding: 10px 0; border-radius: 8px; text-decoration: none; font-weight: bold; font-family: 'Orbitron', sans-serif; font-size: 12px; border: 1px solid #555; transition: 0.3s; }
        .visit-btn:hover { background: #fff; color: #000; }
        .report-btn { background: #fff; color: #000; border: none; font-weight: 800; } 
        
        .action-btn { background: #222; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .edit-btn:hover { background: #ffeb3b; color: #000; } .delete-btn:hover { background: #ff4444; color: white; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal { background: #111; padding: 30px; border-radius: 15px; border: 1px solid #00ff88; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto;}
        .modal h3 { color: #00ff88; margin-top: 0; font-family: 'Orbitron', sans-serif; }
        .modal input, .modal select { width: 100%; padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; }
        .save-btn { flex: 1; background: #00ff88; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .cancel-btn { flex: 1; background: #333; color: #fff; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }
        .footer { margin-top: 50px; font-size: 14px; color: #888; font-family: 'Orbitron', sans-serif; }
        .footer span { color: #00ff88; font-weight: bold; }
    </style>
</head>
<body>
    <a href="javascript:void(0)" onclick="goToAdd()" class="nav-btn">‚ûï ADD EVENT</a>
    <button onclick="logout()" class="auth-btn">LOGOUT üîí</button>
    <h2>UPCOMING EVENTS üöÄ</h2>
    
    <div class="filter-container">
        <input type="text" id="search-input" class="search-box" placeholder="üîç Search Hackathon..." oninput="filterHackathons()">
        <select id="mode-filter" class="filter-select" onchange="filterHackathons()">
            <option value="All">All Modes</option><option value="Online">Online</option><option value="Offline">Offline</option><option value="Hybrid">Hybrid</option>
        </select>
    </div>

    <div class="list-container" id="hackList"><p style="text-align: center; color: #555;">Loading Data...</p></div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3>EDIT DETAILS ‚úèÔ∏è</h3>
            <input type="hidden" id="edit-id">
            <label style="font-size:12px; color:#aaa">Event Name</label><input type="text" id="edit-name">
            <label style="font-size:12px; color:#aaa">Start Date</label><input type="date" id="edit-date">
            <label style="font-size:12px; color:#aaa">End Date</label><input type="date" id="edit-end-date">
            <label style="font-size:12px; color:#aaa">Team Members</label><input type="text" id="edit-members">
            <label style="font-size:12px; color:#aaa">Registered? ‚úÖ</label><select id="edit-reg"><option value="Yes">Yes</option><option value="No">No</option></select>
            <label style="font-size:12px; color:#aaa">Current Status üö¶</label>
            <select id="edit-status">
                <option value="Interested">Interested</option><option value="Applied">Applied</option><option value="Shortlisted">Shortlisted</option><option value="Rejected">Rejected</option><option value="Winner">Winner üèÜ</option>
            </select>
            <label style="font-size:12px; color:#00d4ff">Certificate Link</label><input type="url" id="edit-cert">
            <label style="font-size:12px; color:#00d4ff">Photos Link</label><input type="url" id="edit-photos">
            <div class="modal-actions"><button class="save-btn" onclick="saveEdit()">SAVE</button><button class="cancel-btn" onclick="closeModal()">CANCEL</button></div>
        </div>
    </div>
    <div class="footer">Made by <span>BitRise</span> üöÄ</div>

    <script>
        const API_URL = (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") ? "http://localhost:5000/api/hackathons" : "https://hackathontracker.onrender.com/api/hackathons";
        const listDiv = document.getElementById('hackList');
        const modal = document.getElementById('editModal');
        const isLoggedIn = localStorage.getItem("isTeamMember") === "true";
        let allHackathons = [];

        function goToAdd() { if (isLoggedIn) window.location.href = "index.html"; else window.location.href = "login.html"; }
        function logout() { localStorage.removeItem("isTeamMember"); window.location.href = "login.html"; }

        function triggerConfetti() {
            var duration = 3000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        async function loadHackathons() {
            try {
                const res = await fetch(API_URL); let data = await res.json();
                data.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                allHackathons = data; renderList(allHackathons);
            } catch (err) { console.error(err); listDiv.innerHTML = "<p style='color:red; text-align:center;'>Server Error!</p>"; }
        }

        function filterHackathons() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const mode = document.getElementById('mode-filter').value;
            const filteredData = allHackathons.filter(hack => {
                const matchesName = hack.name.toLowerCase().includes(query);
                const matchesMode = mode === "All" || hack.mode === mode;
                return matchesName && matchesMode;
            });
            renderList(filteredData);
        }

        function renderList(data) {
            listDiv.innerHTML = "";
            if (data.length === 0) { listDiv.innerHTML = "<p style='color:#777; text-align:center;'>No match found.</p>"; return; }

            data.forEach(hack => {
                const pptClass = hack.pptNeeded === 'Yes' ? 'yes' : 'no';
                const regClass = hack.registered === 'Yes' ? 'yes' : 'no';
                const currentStatus = hack.currentStatus || 'Interested'; const statusClass = `status-${currentStatus}`;
                let membersList = hack.teamMembers ? hack.teamMembers.split(',').map(s => s.trim()).filter(s => s) : [];
                let vacancy = hack.teamSize - membersList.length;
                let statusText = vacancy > 0 ? `üü¢ ${vacancy} Slot(s) Open` : `üî¥ Team Full`;
                let statusColorClass = vacancy > 0 ? 'status-open' : 'status-full';

                const adminButtons = isLoggedIn ? `
                    <button class="action-btn edit-btn" onclick="openEdit('${hack._id}', '${hack.name}', '${hack.startDate}', '${hack.endDate}', '${hack.registered}', '${currentStatus}', '${hack.teamMembers || ''}', '${hack.certificate || ''}', '${hack.photos || ''}')">‚úèÔ∏è</button>
                    <button class="action-btn delete-btn" onclick="deleteHack('${hack._id}')">üóëÔ∏è</button>` : '';

                const certBtn = hack.certificate ? `<a href="${hack.certificate}" target="_blank" class="proof-btn">üìú Cert</a>` : '';
                const photoBtn = hack.photos ? `<a href="${hack.photos}" target="_blank" class="proof-btn">üì∑ Photos</a>` : '';

                const card = `
                    <div class="hackathon-card ${statusClass}">
                        <div class="title">${hack.name}</div>
                        <div class="countdown-timer" id="timer-${hack._id}" data-date="${hack.startDate}">Loading...</div>
                        <div class="date-highlight">üìÖ ${hack.startDate} <span style="font-size:12px; color:#aaa; margin:0 5px;">to</span> ${hack.endDate}</div>
                        <span class="organizer">By ${hack.organizer}</span>
                        <div class="info-row"><span>üìç ${hack.location} (${hack.mode})</span></div>
                        <div style="margin-top: 10px; display:flex; gap:5px;">
                            <span class="badge ${pptClass}">PPT: ${hack.pptNeeded}</span>
                            <span class="badge ${regClass}">Reg: ${hack.registered}</span>
                            <span class="status-badge">üö¶ ${currentStatus}</span>
                        </div>
                        <div class="team-section">
                            <span class="team-status ${statusColorClass}">${statusText} (${membersList.length}/${hack.teamSize})</span>
                            <div class="member-list">${membersList.length > 0 ? membersList.join(', ') : 'No members yet'}</div>
                        </div>
                        
                        <div style="margin-top:10px; display:flex; gap:5px;">${certBtn} ${photoBtn}</div>

                        <div class="btn-group">
                            <a href="${hack.link}" target="_blank" class="visit-btn">VISIT LINK ‚Üó</a>
                            <a href="report.html?id=${hack._id}" target="_blank" class="visit-btn report-btn">üìÑ REPORT</a>
                            ${adminButtons}
                        </div>
                    </div>`;
                listDiv.innerHTML += card;
            });
            startCountdown();
        }

        function startCountdown() {
            setInterval(() => {
                const timers = document.querySelectorAll('.countdown-timer');
                timers.forEach(timer => {
                    const eventDate = new Date(timer.getAttribute('data-date')).getTime();
                    const now = new Date().getTime();
                    const distance = eventDate - now;
                    if (distance < 0) { timer.innerHTML = "üî¥ EVENT STARTED"; timer.style.color = "#ff4444"; timer.style.borderColor = "#ff4444"; } 
                    else {
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        timer.innerHTML = `‚è≥ ${days}d ${hours}h ${minutes}m ${seconds}s`;
                    }
                });
            }, 1000);
        }

        async function deleteHack(id) { if(!confirm("Delete this?")) return; await fetch(`${API_URL}/${id}`, { method: 'DELETE' }); loadHackathons(); }

        function openEdit(id, name, date, endDate, reg, status, members, cert, photos) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-date').value = date;
            document.getElementById('edit-end-date').value = endDate;
            document.getElementById('edit-members').value = members;
            document.getElementById('edit-reg').value = reg;
            document.getElementById('edit-status').value = status;
            document.getElementById('edit-cert').value = cert;
            document.getElementById('edit-photos').value = photos;
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        
        async function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const status = document.getElementById('edit-status').value;
            if (status === "Winner") triggerConfetti();

            const updatedData = {
                name: document.getElementById('edit-name').value,
                startDate: document.getElementById('edit-date').value,
                endDate: document.getElementById('edit-end-date').value,
                teamMembers: document.getElementById('edit-members').value,
                registered: document.getElementById('edit-reg').value,
                currentStatus: status,
                certificate: document.getElementById('edit-cert').value,
                photos: document.getElementById('edit-photos').value
            };
            await fetch(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData) });
            closeModal(); loadHackathons();
        }
        loadHackathons();
    </script>
</body>
</html>